<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NeuroG-Synth ∞ Pattern Lab – by caiusdesigns</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg-0: #050309;
      --bg-1: #190b33;
      --bg-2: #07050c;
      --accent: #ffcf7f;
      --accent-soft: #f8b5a8;
      --accent-strong: #ff7a8b;
      --text-main: #f5f5f5;
      --text-muted: #aea3c8;
      --panel: rgba(14, 9, 30, 0.96);
      --border: rgba(182, 138, 255, 0.9);
      --grid-line: rgba(120, 90, 180, 0.3);
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, var(--bg-1) 0, var(--bg-2) 45%, #000 100%);
      color: var(--text-main);
    }
    body {
      display: flex;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      padding: 20px 14px 40px;
    }
    @media (min-width: 900px) {
      .app { padding: 26px 18px 48px; }
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 18px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-logo {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      background:
        radial-gradient(circle at 25% 20%, #fff9e3 0, #ffd39f 45%, #f4948e 70%, #2b0c2c 100%);
      position: relative;
      box-shadow:
        0 0 18px rgba(255, 201, 128, 0.9),
        0 0 32px rgba(255, 122, 139, 0.55);
      overflow: hidden;
    }
    .brand-logo::before,
    .brand-logo::after {
      content: "";
      position: absolute;
      inset: 20%;
      border-radius: 2px;
      border: 1px solid rgba(70, 25, 80, 0.7);
    }
    .brand-logo::after {
      inset: 36%;
      border-color: rgba(255, 255, 255, 0.52);
    }
    .brand-title {
      font-size: 1.25rem;
      font-weight: 650;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    .brand-title span { color: var(--accent); }
    .brand-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }
    .tag {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 220, 180, 0.95);
      background: radial-gradient(circle at top left, rgba(255, 205, 130, 0.18), rgba(4, 2, 8, 0.98));
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .tag-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow:
        0 0 12px rgba(255, 207, 127, 1),
        0 0 23px rgba(255, 146, 125, 0.85);
    }

    .layout {
      display: grid;
      gap: 16px;
    }
    @media (min-width: 950px) {
      .layout {
        grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.2fr);
      }
    }
    .panel {
      background: var(--panel);
      border-radius: 10px;
      border: 1px solid var(--border);
      box-shadow: 0 0 24px rgba(40, 14, 70, 0.7);
      padding: 14px 12px;
    }
    @media (min-width: 900px) {
      .panel { padding: 16px 14px; }
    }
    .panel-header {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .panel-title {
      font-size: 1.1rem;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }
    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 7px 16px;
      font-size: 0.8rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      transition: transform 0.07s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #1a0804;
      box-shadow:
        0 0 18px rgba(255, 207, 127, 0.9),
        0 0 32px rgba(255, 122, 139, 0.65);
      border-color: rgba(114, 64, 22, 0.95);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 22px rgba(255, 210, 130, 1),
        0 0 36px rgba(255, 122, 139, 0.8);
    }
    .btn-ghost {
      border-color: rgba(171, 132, 222, 0.9);
      background: radial-gradient(circle at top, rgba(40, 16, 70, 0.98), rgba(7, 3, 15, 0.98));
      color: var(--text-main);
    }
    .btn-ghost:hover {
      transform: translateY(-1px);
      border-color: rgba(255, 220, 180, 0.95);
      box-shadow: 0 0 18px rgba(160, 120, 230, 0.55);
    }

    .knob-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .knob {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }
    .knob label {
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }
    .knob span {
      font-variant-numeric: tabular-nums;
    }
    .knob input[type="range"] {
      width: 120px;
    }
    .tempo {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }
    .tempo input[type="range"] {
      width: 140px;
    }

    /* Sequencer grid */
    .seq-wrapper {
      margin-top: 10px;
    }
    .seq-header {
      display: grid;
      grid-template-columns: 80px repeat(16, 1fr);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }
    .seq-header div {
      text-align: center;
    }
    .seq-grid {
      border-radius: 8px;
      border: 1px solid rgba(171, 132, 222, 0.8);
      overflow: hidden;
    }
    .seq-row {
      display: grid;
      grid-template-columns: 80px repeat(16, 1fr);
      border-bottom: 1px solid var(--grid-line);
    }
    .seq-row:last-child {
      border-bottom: none;
    }
    .seq-label {
      display: flex;
      align-items: center;
      padding-left: 6px;
      font-size: 0.76rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      background: rgba(13, 7, 27, 0.98);
    }
    .seq-cell {
      position: relative;
      height: 22px;
      border-left: 1px solid var(--grid-line);
      background: rgba(16, 7, 35, 0.9);
      cursor: pointer;
      overflow: hidden;
    }
    .seq-cell:first-of-type {
      border-left: none;
    }
    .seq-cell::before {
      content: "";
      position: absolute;
      inset: 4px 4px auto 4px;
      border-radius: 2px;
      background: transparent;
      transform-origin: bottom;
      transform: scaleY(0);
      transition: background 0.12s ease, transform 0.12s ease, box-shadow 0.12s ease;
    }
    .seq-cell[data-level="1"]::before {
      background: rgba(255, 207, 127, 0.65);
      transform: scaleY(0.45);
      box-shadow: 0 0 6px rgba(255, 207, 127, 0.9);
    }
    .seq-cell[data-level="2"]::before {
      background: rgba(255, 122, 139, 0.85);
      transform: scaleY(1);
      box-shadow:
        0 0 6px rgba(255, 207, 127, 1),
        0 0 12px rgba(255, 122, 139, 0.9);
    }
    .seq-cell[data-active-step="true"] {
      background: rgba(40, 18, 80, 0.95);
    }

    .seq-legend {
      margin-top: 6px;
      font-size: 0.74rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .subtitle {
      margin-top: 10px;
      font-size: 0.82rem;
      color: var(--accent-soft);
      min-height: 1.6em;
    }

    /* Right side */
    .meta-row {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .meta-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(205, 166, 255, 0.8);
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.13em;
      margin-right: 4px;
    }
    .nis-box {
      width: 100%;
      min-height: 220px;
      max-height: 340px;
      border-radius: 8px;
      border: 1px solid rgba(171, 132, 222, 0.9);
      background: radial-gradient(circle at top, rgba(52, 22, 90, 0.9), rgba(8, 2, 20, 0.98));
      color: var(--text-main);
      padding: 10px 10px 12px;
      font-size: 0.84rem;
      line-height: 1.4;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .small-note {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="brand-logo"></div>
        <div>
          <div class="brand-title">NeuroG-<span>Synth ∞</span> Pattern Lab</div>
          <div class="brand-sub">Neuro-sequencer • by caiusdesigns</div>
        </div>
      </div>
      <div class="tag">
        <span class="tag-dot"></span>
        <span>16-step pattern • local web audio</span>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT: SEQUENCER -->
      <section class="panel">
        <div class="panel-header">Pattern engine</div>
        <div class="panel-title">Sequenced body-state modulation</div>

        <div class="controls-row">
          <button class="btn btn-primary" id="playBtn">▶ Play pattern</button>
          <button class="btn btn-ghost" id="stopBtn" disabled>■ Stop</button>
          <div class="tempo">
            <label for="tempo">Tempo (BPM)</label>
            <input id="tempo" type="range" min="30" max="140" value="80" />
            <span id="tempoVal">80</span>
          </div>
        </div>

        <div class="controls-row">
          <div class="knob">
            <label for="intensity">Intensity</label>
            <input id="intensity" type="range" min="0" max="1" step="0.01" value="0.5" />
            <span id="intensityVal">0.50</span>
          </div>
          <div class="knob">
            <label for="warmth">Warmth</label>
            <input id="warmth" type="range" min="0" max="1" step="0.01" value="0.6" />
            <span id="warmthVal">0.60</span>
          </div>
          <div class="knob">
            <label for="depth">Depth</label>
            <input id="depth" type="range" min="0" max="1" step="0.01" value="0.6" />
            <span id="depthVal">0.60</span>
          </div>
        </div>

        <div class="controls-row">
          <div class="knob">
            <label for="volume">Volume</label>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8" />
            <span id="volumeVal">0.80</span>
          </div>
          <button class="btn btn-ghost" id="randomizeBtn">✱ Randomize pattern</button>
          <button class="btn btn-ghost" id="clearBtn">⨂ Clear</button>
        </div>

        <div class="seq-wrapper">
          <div class="seq-header">
            <div>Lane</div>
            <!-- 16 steps -->
            <div>1</div><div>2</div><div>3</div><div>4</div>
            <div>5</div><div>6</div><div>7</div><div>8</div>
            <div>9</div><div>10</div><div>11</div><div>12</div>
            <div>13</div><div>14</div><div>15</div><div>16</div>
          </div>
          <div class="seq-grid" id="seqGrid">
            <!-- rows will be built by JS -->
          </div>
          <div class="seq-legend">
            <span>Click cells to cycle: off → low → high.</span>
            <span>Rows:</span>
            <span><strong>Reward</strong> = dopamine / ACh drive</span>
            <span><strong>Stress</strong> = cortisol vs GABA</span>
            <span><strong>Calm</strong> = parasympathetic safety</span>
            <span><strong>Breath</strong> = inhale / exhale / hold pattern</span>
          </div>
        </div>

        <div class="subtitle" id="subtitle">
          Step subtitles will appear here as the pattern runs.
        </div>
      </section>

      <!-- RIGHT: META + NIS -->
      <section class="panel">
        <div class="panel-header">Patch / protocol</div>
        <div class="panel-title">Psychoacoustic state + textual map</div>

        <div class="meta-row">
          <span class="meta-pill" id="bandMeta">Band: –</span>
          <span class="meta-pill" id="carrierMeta">Carrier: – Hz</span>
          <span class="meta-pill" id="pulseMeta">Pulse: – Hz</span>
          <span class="meta-pill" id="binauralMeta">Binaural: off</span>
        </div>

        <div class="nis-box" id="nisBox">
          Draw a pattern and press <strong>Play pattern</strong>. This box will describe the overall
          block (Neural Instruction Sequence) in plain language.
        </div>

        <div class="small-note">
          Mobile note: first tap on <strong>Play pattern</strong> unlocks audio (iOS / Android). Make
          sure device volume is up and not on silent.
        </div>
      </section>
    </main>
  </div>

  <script>
    // ------- PATTERN MODEL -------
    const lanes = [
      { key: "reward", label: "Reward", description: "dopamine / ACh drive" },
      { key: "stress", label: "Stress", description: "cortisol vs GABA" },
      { key: "calm", label: "Calm", description: "parasympathetic safety" },
      { key: "breath", label: "Breath", description: "inhale / exhale / hold rhythm" }
    ];
    const steps = 16;
    // pattern[level]: 0=off,1=low,2=high
    let pattern = lanes.map(() => Array(steps).fill(0));

    const seqGrid = document.getElementById("seqGrid");
    const subtitleEl = document.getElementById("subtitle");
    const nisBox = document.getElementById("nisBox");

    const tempoSlider = document.getElementById("tempo");
    const tempoVal = document.getElementById("tempoVal");
    const intensitySlider = document.getElementById("intensity");
    const intensityVal = document.getElementById("intensityVal");
    const warmthSlider = document.getElementById("warmth");
    const warmthVal = document.getElementById("warmthVal");
    const depthSlider = document.getElementById("depth");
    const depthVal = document.getElementById("depthVal");
    const volumeSlider = document.getElementById("volume");
    const volumeVal = document.getElementById("volumeVal");

    const playBtn = document.getElementById("playBtn");
    const stopBtn = document.getElementById("stopBtn");
    const randomizeBtn = document.getElementById("randomizeBtn");
    const clearBtn = document.getElementById("clearBtn");

    const bandMeta = document.getElementById("bandMeta");
    const carrierMeta = document.getElementById("carrierMeta");
    const pulseMeta = document.getElementById("pulseMeta");
    const binauralMeta = document.getElementById("binauralMeta");

    function updateKnobLabels() {
      tempoVal.textContent = tempoSlider.value;
      intensityVal.textContent = Number(intensitySlider.value).toFixed(2);
      warmthVal.textContent = Number(warmthSlider.value).toFixed(2);
      depthVal.textContent = Number(depthSlider.value).toFixed(2);
      volumeVal.textContent = Number(volumeSlider.value).toFixed(2);
    }
    updateKnobLabels();

    tempoSlider.addEventListener("input", updateKnobLabels);
    intensitySlider.addEventListener("input", updateKnobLabels);
    warmthSlider.addEventListener("input", updateKnobLabels);
    depthSlider.addEventListener("input", updateKnobLabels);
    volumeSlider.addEventListener("input", () => {
      updateKnobLabels();
      if (masterGain) masterGain.gain.value = Number(volumeSlider.value);
    });

    // Build grid
    function buildGrid() {
      seqGrid.innerHTML = "";
      lanes.forEach((lane, laneIndex) => {
        const row = document.createElement("div");
        row.className = "seq-row";
        const label = document.createElement("div");
        label.className = "seq-label";
        label.textContent = lane.label;
        row.appendChild(label);

        for (let stepIndex = 0; stepIndex < steps; stepIndex++) {
          const cell = document.createElement("div");
          cell.className = "seq-cell";
          cell.dataset.lane = String(laneIndex);
          cell.dataset.step = String(stepIndex);
          cell.dataset.level = String(pattern[laneIndex][stepIndex]);
          cell.addEventListener("click", () => {
            let level = pattern[laneIndex][stepIndex];
            level = (level + 1) % 3; // 0 -> 1 -> 2 -> 0
            pattern[laneIndex][stepIndex] = level;
            cell.dataset.level = String(level);
            if (!isPlaying) {
              describeBlockText();
            }
          });
          row.appendChild(cell);
        }
        seqGrid.appendChild(row);
      });
    }
    buildGrid();

    // ------- AUDIO ENGINE (V4.1 STYLE) -------
    let audioCtx = null;
    let masterGain = null;
    let isPlaying = false;
    let currentOscLeft = null;
    let currentOscRight = null;
    let pulseGain = null;
    let pulseInterval = null;
    let stepTimer = null;
    let currentStep = 0;
    let currentPatch = null;

    function ensureAudioContext() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = Number(volumeSlider.value);
        masterGain.connect(audioCtx.destination);
      }
      if (audioCtx.state === "suspended") {
        return audioCtx.resume();
      }
      return Promise.resolve();
    }

    function getStepVector(stepIndex) {
      // Aggregate pattern levels for this step
      const rewardLevel = pattern[0][stepIndex]; // 0-2
      const stressLevel = pattern[1][stepIndex];
      const calmLevel = pattern[2][stepIndex];
      const breathLevel = pattern[3][stepIndex];

      // Map to conceptual values (-5..5 style)
      const intensity = Number(intensitySlider.value); // 0-1
      const depth = Number(depthSlider.value);
      const warmth = Number(warmthSlider.value);

      // reward: dopamine / ACh
      const da = Math.round((rewardLevel - 0.5) * 6 * intensity);
      const ach = Math.round((rewardLevel - 0.3) * 5 * intensity);

      // stress vs calm → cortisol / GABA
      const cort = Math.round((stressLevel - calmLevel) * 4 * depth);
      const gaba = Math.round((calmLevel - stressLevel * 0.5) * 4 * depth);

      // basic band selection
      let mode = "neutral";
      if (rewardLevel > 0 && stressLevel === 0) mode = "focus/drive";
      if (calmLevel > 0 && stressLevel === 0) mode = "calm";
      if (stressLevel > 0 && calmLevel === 0) mode = "stress unload";
      if (breathLevel > 0 && calmLevel > 0) mode = "breath-calming";

      return {
        rewardLevel,
        stressLevel,
        calmLevel,
        breathLevel,
        da,
        ach,
        cort,
        gaba,
        intensity,
        warmth,
        depth,
        mode
      };
    }

    function buildPatchForStep(stepIndex) {
      const v = getStepVector(stepIndex);
      let baseFreq = 220;
      // reward/drive pushes up
      if (v.rewardLevel === 1) baseFreq = 260;
      if (v.rewardLevel === 2) baseFreq = 320;
      // calm pulls down
      if (v.calmLevel === 1) baseFreq -= 30;
      if (v.calmLevel === 2) baseFreq -= 60;
      // stress edges tone
      if (v.stressLevel > 0) baseFreq += 20 * v.stressLevel;

      // clamp
      baseFreq = Math.max(120, Math.min(420, baseFreq));

      // entrainment band/pulse
      let pulseHz = 10;
      let bandLabel = "alpha";
      if (v.mode === "focus/drive") {
        pulseHz = 18;
        bandLabel = "high beta";
      } else if (v.mode === "calm" || v.mode === "breath-calming") {
        pulseHz = 8;
        bandLabel = "alpha";
      } else if (v.mode === "stress unload") {
        pulseHz = 14;
        bandLabel = "beta";
      }

      // binaural offset
      let binauralHz = 0;
      if (v.calmLevel > 0) {
        binauralHz = 4; // theta-ish
      } else if (v.rewardLevel > 0) {
        binauralHz = 10; // beta-ish
      }

      // warmth factor (timbre)
      let warmth = v.warmth;
      if (v.calmLevel > 0) warmth = Math.max(warmth, 0.6);
      if (v.stressLevel > 0) warmth *= 0.8;

      return {
        baseFreq,
        pulseHz,
        binauralHz,
        warmth,
        bandLabel,
        vec: v
      };
    }

    function updateMetaForPatch(patch) {
      if (!patch) {
        bandMeta.textContent = "Band: –";
        carrierMeta.textContent = "Carrier: – Hz";
        pulseMeta.textContent = "Pulse: – Hz";
        binauralMeta.textContent = "Binaural: off";
        return;
      }
      bandMeta.textContent = "Band: " + patch.bandLabel;
      carrierMeta.textContent = "Carrier: " + patch.baseFreq.toFixed(0) + " Hz";
      pulseMeta.textContent = "Pulse: " + patch.pulseHz.toFixed(1) + " Hz";
      binauralMeta.textContent =
        "Binaural: " + (patch.binauralHz ? patch.binauralHz + " Hz" : "off");
    }

    function describeStepSubtitle(stepIndex, patch) {
      const v = patch.vec;
      const n = stepIndex + 1;
      let parts = [`Step ${n}: `];

      if (v.rewardLevel > 0) {
        parts.push(
          v.rewardLevel === 1 ? "gentle drive" : "strong drive"
        );
      }
      if (v.calmLevel > 0) {
        parts.push(
          v.calmLevel === 1 ? "soft calm" : "deep parasympathetic drop"
        );
      }
      if (v.stressLevel > 0) {
        parts.push(
          v.stressLevel === 1 ? "stress edge" : "strong stress unload cue"
        );
      }
      if (v.breathLevel > 0) {
        if (v.breathLevel === 1) parts.push("normal inhale / exhale");
        if (v.breathLevel === 2) parts.push("extend exhale on this step");
      }

      if (parts.length === 1) {
        parts.push("neutral bridge / coast.");
      } else {
        parts.push(".");
      }

      subtitleEl.textContent = parts.join(" ");
    }

    function describeBlockText() {
      // simple summary of pattern overall
      let rewardSum = 0,
        stressSum = 0,
        calmSum = 0,
        breathSum = 0;
      for (let i = 0; i < steps; i++) {
        rewardSum += pattern[0][i];
        stressSum += pattern[1][i];
        calmSum += pattern[2][i];
        breathSum += pattern[3][i];
      }
      const totalActive =
        rewardSum + stressSum + calmSum + breathSum;

      const lines = [];
      lines.push("NEUROG-SYNTH ∞ PATTERN LAB – BLOCK DESCRIPTION");
      lines.push("----------------------------------------------");
      lines.push(`Pattern length: ${steps} steps, tempo ${tempoSlider.value} BPM.`);
      lines.push(
        `Global knobs → Intensity ${Number(intensitySlider.value).toFixed(
          2
        )}, Warmth ${Number(warmthSlider.value).toFixed(
          2
        )}, Depth ${Number(depthSlider.value).toFixed(2)}.`
      );
      lines.push("");
      lines.push(
        `Reward lane (DA/ACh): ${rewardSum} total activation points across the loop.`
      );
      lines.push(
        `Stress lane (cortisol vs GABA): ${stressSum} points (more = more edges to unload).`
      );
      lines.push(
        `Calm lane (parasympathetic safety): ${calmSum} points (more = more alpha / theta drift).`
      );
      lines.push(
        `Breath lane: ${breathSum} marked steps (exhale / hold emphasis).`
      );
      lines.push("");
      if (totalActive === 0) {
        lines.push(
          "This pattern is currently neutral. Light some cells in Reward / Calm / Breath to create a body-state script."
        );
      } else {
        lines.push(
          "Interpretation: this block will cycle a repeating script of reward drive, stress edges, and calm steps, guided by your pattern."
        );
        lines.push(
          "Headphones, comfortable posture, eyes-open or soft-focus. Let the subtitles guide tiny breath / body adjustments as each step lights."
        );
      }
      nisBox.textContent = lines.join("\n");
    }
    describeBlockText();

    function clearPattern() {
      pattern = lanes.map(() => Array(steps).fill(0));
      buildGrid();
      describeBlockText();
    }

    function randomizePattern() {
      pattern = lanes.map((lane, li) =>
        Array(steps)
          .fill(0)
          .map((_, si) => {
            // reward + calm denser, stress sparser
            const r = Math.random();
            if (li === 0) { // reward
              if (r < 0.35) return 1;
              if (r < 0.55) return 2;
              return 0;
            }
            if (li === 2) { // calm
              if (r < 0.4) return 1;
              if (r < 0.6) return 2;
              return 0;
            }
            if (li === 1) { // stress
              if (r < 0.18) return 1;
              if (r < 0.26) return 2;
              return 0;
            }
            // breath: pattern-y
            if (li === 3) {
              if (si % 4 === 3) return 2; // exhale step
              if (si % 4 === 0 && r < 0.5) return 1; // inhale emphasis
              return 0;
            }
            return 0;
          })
      );
      buildGrid();
      describeBlockText();
    }

    clearBtn.addEventListener("click", () => {
      clearPattern();
    });
    randomizeBtn.addEventListener("click", () => {
      randomizePattern();
    });

    function setActiveStepHighlight(stepIndex) {
      const cells = seqGrid.querySelectorAll(".seq-cell");
      cells.forEach((cell) => {
        if (Number(cell.dataset.step) === stepIndex) {
          cell.dataset.activeStep = "true";
        } else {
          cell.dataset.activeStep = "false";
        }
      });
    }

    function startPattern() {
      ensureAudioContext()
        .then(() => {
          stopPattern(); // reset
          isPlaying = true;
          playBtn.textContent = "⏸ Pause";
          stopBtn.disabled = false;

          const bpm = Number(tempoSlider.value);
          const stepDuration = 60 / bpm / 2; // 8th-note-ish, tweakable
          currentStep = 0;

          // start patch for first step
          applyPatchForStep(currentStep);

          stepTimer = setInterval(() => {
            if (!isPlaying) return;
            currentStep = (currentStep + 1) % steps;
            applyPatchForStep(currentStep);
          }, stepDuration * 1000);
        })
        .catch((err) => {
          console.error("audio error:", err);
          subtitleEl.textContent =
            "Audio blocked by browser. Reload page, tap Play again with sound on.";
        });
    }

    function stopPattern() {
      if (stepTimer) {
        clearInterval(stepTimer);
        stepTimer = null;
      }
      if (pulseInterval) {
        clearInterval(pulseInterval);
        pulseInterval = null;
      }
      if (currentOscLeft) {
        try { currentOscLeft.stop(); } catch (e) {}
        currentOscLeft.disconnect();
        currentOscLeft = null;
      }
      if (currentOscRight) {
        try { currentOscRight.stop(); } catch (e) {}
        currentOscRight.disconnect();
        currentOscRight = null;
      }
      isPlaying = false;
      playBtn.textContent = "▶ Play pattern";
      stopBtn.disabled = true;
      setActiveStepHighlight(-1);
    }

    function applyPatchForStep(stepIndex) {
      const patch = (currentPatch = buildPatchForStep(stepIndex));
      updateMetaForPatch(patch);
      describeStepSubtitle(stepIndex, patch);
      describeBlockText();
      setActiveStepHighlight(stepIndex);

      ensureAudioContext().then(() => {
        // rebuild oscillators for each step for clarity
        if (currentOscLeft) {
          try { currentOscLeft.stop(); } catch (e) {}
          currentOscLeft.disconnect();
        }
        if (currentOscRight) {
          try { currentOscRight.stop(); } catch (e) {}
          currentOscRight.disconnect();
        }
        if (pulseInterval) {
          clearInterval(pulseInterval);
          pulseInterval = null;
        }

        const leftOsc = audioCtx.createOscillator();
        const rightOsc = audioCtx.createOscillator();
        const leftGain = audioCtx.createGain();
        const rightGain = audioCtx.createGain();
        pulseGain = audioCtx.createGain();

        const base = patch.baseFreq;
        const spread = base * patch.warmth * 0.2;

        leftOsc.frequency.value = base - spread;
        rightOsc.frequency.value = base + spread + patch.binauralHz;

        leftOsc.type = "sine";
        rightOsc.type = patch.warmth > 0.6 ? "triangle" : "sine";

        leftGain.gain.value = 0.55;
        rightGain.gain.value = 0.55;

        leftOsc.connect(leftGain);
        rightOsc.connect(rightGain);
        const merger = audioCtx.createChannelMerger(2);
        leftGain.connect(merger, 0, 0);
        rightGain.connect(merger, 0, 1);

        merger.connect(pulseGain);
        pulseGain.connect(masterGain);

        const pulseHz = patch.pulseHz;
        const pulsePeriod = 1 / pulseHz;
        const depth = 0.6 * patch.vec.depth;

        pulseGain.gain.value = 1 - depth / 2;

        const schedulePulse = () => {
          const now = audioCtx.currentTime;
          pulseGain.gain.cancelScheduledValues(now);
          for (let i = 0; i < 4; i++) {
            const t0 = now + i * pulsePeriod;
            const t1 = t0 + pulsePeriod / 2;
            pulseGain.gain.setValueAtTime(1, t0);
            pulseGain.gain.linearRampToValueAtTime(1 - depth, t1);
          }
        };
        schedulePulse();
        pulseInterval = setInterval(schedulePulse, 4000);

        leftOsc.start();
        rightOsc.start();

        currentOscLeft = leftOsc;
        currentOscRight = rightOsc;
      });
    }

    playBtn.addEventListener("click", () => {
      if (!isPlaying) {
        startPattern();
      } else {
        // pause = stop audio but keep pattern on screen
        stopPattern();
      }
    });
    stopBtn.addEventListener("click", () => {
      stopPattern();
    });
  </script>
</body>
</html>
