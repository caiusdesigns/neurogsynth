<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NeuroG-Synth ∞ V4.2 – by caiusdesigns</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg-0: #050309;
      --bg-1: #191426;
      --bg-2: #07050c;
      --accent: #ffcf7f;
      --accent-strong: #ff7a8b;
      --accent-soft: #f8b6a8;
      --text-main: #f5f5f5;
      --text-muted: #aea3c8;
      --panel: rgba(14, 9, 30, 0.96);
      --border: rgba(182, 138, 255, 0.9);
      --grid-line: rgba(120, 90, 180, 0.35);
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background:
        radial-gradient(circle at top, #191426 0, #07050c 40%, #000 100%);
      color: var(--text-main);
    }
    body {
      display: flex;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      padding: 20px 14px 40px;
    }
    @media (min-width: 900px) {
      .app { padding: 26px 18px 48px; }
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 18px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .brand-logo {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      background:
        radial-gradient(circle at 25% 20%, #fff9e3 0, #ffd39f 45%, #f4948e 70%, #2b0c2c 100%);
      position: relative;
      box-shadow:
        0 0 18px rgba(255, 201, 128, 0.9),
        0 0 32px rgba(255, 122, 139, 0.55);
      overflow: hidden;
    }
    .brand-logo::before,
    .brand-logo::after {
      content: "";
      position: absolute;
      inset: 20%;
      border-radius: 2px;
      border: 1px solid rgba(70, 25, 80, 0.7);
    }
    .brand-logo::after {
      inset: 36%;
      border-color: rgba(255, 255, 255, 0.52);
    }
    .brand-title {
      font-size: 1.3rem;
      font-weight: 650;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    .brand-title span { color: var(--accent); }
    .brand-sub {
      font-size: 0.8rem;
      color: var(--text-muted);
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }
    .tag {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 220, 180, 0.95);
      background: radial-gradient(circle at top left, rgba(255, 205, 130, 0.18), rgba(4, 2, 8, 0.98));
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .tag-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow:
        0 0 12px rgba(255, 207, 127, 1),
        0 0 23px rgba(255, 146, 125, 0.85);
    }

    .layout {
      display: grid;
      gap: 16px;
    }
    @media (min-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.25fr);
      }
    }

    .panel {
      background: var(--panel);
      border-radius: 10px;
      border: 1px solid var(--border);
      box-shadow: 0 0 24px rgba(40, 14, 70, 0.7);
      padding: 14px 12px;
    }
    @media (min-width: 900px) {
      .panel { padding: 16px 14px; }
    }
    .panel-header {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .panel-title {
      font-size: 1.1rem;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .state-grid {
      display: grid;
      gap: 10px;
    }
    @media (min-width: 1000px) {
      .state-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    .group-title {
      font-size: 0.84rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--accent-soft);
      margin-bottom: 4px;
    }
    .slider-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 6px;
    }
    .slider-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-bottom: 2px;
    }
    .slider-label span:first-child { color: var(--text-main); }
    .slider-label span:last-child {
      color: var(--text-muted);
      font-variant-numeric: tabular-nums;
    }
    .slider-row input[type="range"] { width: 100%; }

    .toggle-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .toggle {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(200, 165, 255, 0.75);
      background: radial-gradient(circle at top left, rgba(140, 94, 225, 0.7), rgba(15, 4, 32, 0.98));
      color: var(--text-main);
      cursor: pointer;
      user-select: none;
    }
    .toggle[data-active="false"] {
      opacity: 0.4;
      border-style: dashed;
      background: rgba(20, 8, 42, 0.9);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
    }
    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 7px 16px;
      font-size: 0.8rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
      transition: transform 0.07s ease, box-shadow 0.12s ease, border-color 0.12s ease, background 0.12s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #1a0804;
      box-shadow:
        0 0 18px rgba(255, 207, 127, 0.9),
        0 0 32px rgba(255, 122, 139, 0.65);
      border-color: rgba(114, 64, 22, 0.95);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow:
        0 0 22px rgba(255, 210, 130, 1),
        0 0 36px rgba(255, 122, 139, 0.8);
    }
    .btn-ghost {
      border-color: rgba(171, 132, 222, 0.9);
      background: radial-gradient(circle at top, rgba(40, 16, 70, 0.98), rgba(7, 3, 15, 0.98));
      color: var(--text-main);
    }
    .btn-ghost:hover {
      transform: translateY(-1px);
      border-color: rgba(255, 220, 180, 0.95);
      box-shadow: 0 0 18px rgba(160, 120, 230, 0.55);
    }
    .status-text {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .audio-meta {
      margin-top: 8px;
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .meta-pill {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(205, 166, 255, 0.8);
      font-size: 0.74rem;
      text-transform: uppercase;
      letter-spacing: 0.13em;
    }

    .nis-output {
      width: 100%;
      min-height: 200px;
      max-height: 320px;
      border-radius: 8px;
      border: 1px solid rgba(171, 132, 222, 0.9);
      background: radial-gradient(circle at top, rgba(52, 22, 90, 0.9), rgba(8, 2, 20, 0.98));
      color: var(--text-main);
      padding: 10px 10px 12px;
      font-size: 0.84rem;
      line-height: 1.4;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .audio-unlock-banner {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--accent-soft);
    }

    /* Pattern layer */
    .pattern-panel {
      margin-top: 14px;
      padding-top: 10px;
      border-top: 1px solid rgba(171,132,222,0.6);
    }
    .pattern-header {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .pattern-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-bottom: 6px;
      color: var(--accent-soft);
    }
    .pattern-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      border-radius: 8px;
      border: 1px solid rgba(171, 132, 222, 0.8);
      overflow: hidden;
    }
    .pattern-cell {
      position: relative;
      height: 22px;
      border-left: 1px solid var(--grid-line);
      background: rgba(16, 7, 35, 0.9);
      cursor: pointer;
      overflow: hidden;
    }
    .pattern-cell:first-child {
      border-left: none;
    }
    .pattern-cell::before {
      content: "";
      position: absolute;
      inset: 4px 4px auto 4px;
      border-radius: 2px;
      background: transparent;
      transform-origin: bottom;
      transform: scaleY(0);
      transition: background 0.12s ease, transform 0.12s ease, box-shadow 0.12s ease;
    }
    .pattern-cell[data-level="1"]::before {
      background: rgba(255, 207, 127, 0.7);
      transform: scaleY(0.45);
      box-shadow: 0 0 6px rgba(255, 207, 127, 0.9);
    }
    .pattern-cell[data-level="2"]::before {
      background: rgba(255, 122, 139, 0.9);
      transform: scaleY(1);
      box-shadow:
        0 0 6px rgba(255, 207, 127, 1),
        0 0 12px rgba(255, 122, 139, 0.9);
    }
    .pattern-cell[data-active-step="true"] {
      background: rgba(40, 18, 80, 0.95);
    }
    .pattern-legend {
      margin-top: 5px;
      font-size: 0.74rem;
      color: var(--text-muted);
    }
    .pattern-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .pattern-knob {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    .pattern-knob label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }
    .pattern-knob span {
      font-variant-numeric: tabular-nums;
    }
    .pattern-knob input[type="range"] {
      width: 120px;
    }
    .pattern-subtitle {
      margin-top: 5px;
      font-size: 0.78rem;
      color: var(--accent-soft);
      min-height: 1.4em;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="brand-logo"></div>
        <div>
          <div class="brand-title">NeuroG-<span>Synth ∞</span> V4.2</div>
          <div class="brand-sub">State-Vector Console + Pattern Layer • by caiusdesigns</div>
        </div>
      </div>
      <div class="tag">
        <span class="tag-dot"></span>
        <span>Local web audio • experimental</span>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT: STATE VECTOR -->
      <section class="panel">
        <div class="panel-header">State vector</div>
        <div class="panel-title">Neurotransmitters • hormones • mode</div>

        <div class="state-grid">
          <!-- NT GROUP -->
          <div>
            <div class="group-title">Neurotransmitters</div>

            <div class="slider-row">
              <div class="slider-label">
                <span>Dopamine (drive / reward)</span>
                <span id="dopamineVal">0</span>
              </div>
              <input id="dopamine" type="range" min="-5" max="5" step="1" value="0" />
            </div>

            <div class="slider-row">
              <div class="slider-label">
                <span>Serotonin (mood stability)</span>
                <span id="serotoninVal">0</span>
              </div>
              <input id="serotonin" type="range" min="-5" max="5" step="1" value="0" />
            </div>

            <div class="slider-row">
              <div class="slider-label">
                <span>GABA (inhibition / calm)</span>
                <span id="gabaVal">0</span>
              </div>
              <input id="gaba" type="range" min="-5" max="5" step="1" value="0" />
            </div>

            <div class="slider-row">
              <div class="slider-label">
                <span>Acetylcholine (precision / focus)</span>
                <span id="achVal">0</span>
              </div>
              <input id="ach" type="range" min="-5" max="5" step="1" value="0" />
            </div>
          </div>

          <!-- HORMONES / EMOTION -->
          <div>
            <div class="group-title">Hormones & emotional mode</div>

            <div class="slider-row">
              <div class="slider-label">
                <span>Cortisol (stress / arousal)</span>
                <span id="cortisolVal">0</span>
              </div>
              <input id="cortisol" type="range" min="-5" max="5" step="1" value="0" />
            </div>

            <div class="slider-row">
              <div class="slider-label">
                <span>Testosterone / Drive</span>
                <span id="testVal">0</span>
              </div>
              <input id="test" type="range" min="-5" max="5" step="1" value="0" />
            </div>

            <div class="slider-row">
              <div class="slider-label">
                <span>Oxytocin / Social warmth</span>
                <span id="oxyVal">0</span>
              </div>
              <input id="oxy" type="range" min="-5" max="5" step="1" value="0" />
            </div>

            <div class="group-title" style="margin-top:8px;">Target mode</div>
            <div class="toggle-row" id="modeToggles">
              <div class="toggle" data-key="focus" data-active="true">Focus</div>
              <div class="toggle" data-key="calm" data-active="false">Calm</div>
              <div class="toggle" data-key="drive" data-active="false">Drive</div>
              <div class="toggle" data-key="grounded" data-active="false">Grounded</div>
              <div class="toggle" data-key="euphoria" data-active="false">Euphoria</div>
              <div class="toggle" data-key="social" data-active="false">Social</div>
            </div>
          </div>
        </div>

        <div class="controls-row">
          <button class="btn btn-primary" id="compileBtn">Compile NIS</button>
          <button class="btn btn-ghost" id="randomizeBtn">Randomize vector</button>
        </div>
        <div class="status-text" id="vectorSummary">
          Vector idle. Adjust sliders or randomize, then Compile.
        </div>
      </section>

      <!-- RIGHT: AUDIO + NIS + PATTERN -->
      <section class="panel">
        <div class="panel-header">Patch engine</div>
        <div class="panel-title">Warm psychoacoustic patch + NIS</div>

        <div class="controls-row">
          <button class="btn btn-primary" id="playBtn">▶ Play patch</button>
          <button class="btn btn-ghost" id="stopBtn" disabled>■ Stop</button>

          <div style="display:flex;align-items:center;gap:6px;">
            <span style="font-size:0.78rem;color:var(--text-muted);">Volume</span>
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8" />
          </div>
        </div>

        <div class="audio-unlock-banner" id="unlockBanner">
          First tap on <strong>Play patch</strong> unlocks audio on mobile (iOS/Android).
          Make sure phone is not on silent and volume is up.
        </div>

        <div class="audio-meta" id="audioMeta">
          <span class="meta-pill" id="bandMeta">Band: –</span>
          <span class="meta-pill" id="carrierMeta">Carrier: – Hz</span>
          <span class="meta-pill" id="pulseMeta">Pulse: – Hz</span>
          <span class="meta-pill" id="binauralMeta">Binaural: off</span>
        </div>

        <div style="margin-top:10px;font-size:0.8rem;color:var(--text-muted);">
          Neural Instruction Sequence (NIS)
        </div>
        <div class="nis-output" id="nisBox">
          Set a state vector and press <strong>Compile NIS</strong> to generate a micro-protocol.
        </div>

        <!-- PATTERN LAYER -->
        <div class="pattern-panel">
          <div class="pattern-header">Pattern layer (beta)</div>
          <div class="pattern-title">Sequence the patch you just designed</div>

          <div class="pattern-controls">
            <button class="btn btn-ghost" id="patternToggleBtn" data-enabled="false">
              ✱ Enable pattern
            </button>
            <div class="pattern-knob">
              <label for="patternTempo">Tempo (BPM)</label>
              <input id="patternTempo" type="range" min="30" max="140" value="80" />
              <span id="patternTempoVal">80</span>
            </div>
            <div class="pattern-knob">
              <label for="patternDepth">Pattern depth</label>
              <input id="patternDepth" type="range" min="0" max="1" step="0.01" value="0.5" />
              <span id="patternDepthVal">0.50</span>
            </div>
            <button class="btn btn-ghost" id="patternRandomBtn">Randomize</button>
            <button class="btn btn-ghost" id="patternClearBtn">Clear</button>
          </div>

          <div class="pattern-grid" id="patternGrid">
            <!-- 8 cells built by JS -->
          </div>
          <div class="pattern-legend">
            Click cells to cycle: off → low → high. When pattern is enabled and audio
            is playing, each step will gently push/pull the frequency and entrainment.
          </div>
          <div class="pattern-subtitle" id="patternSubtitle">
            Pattern idle. Turn it on to add motion to your patch.
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ------- STATE VECTOR / UI -------
    const sliders = [
      "dopamine",
      "serotonin",
      "gaba",
      "ach",
      "cortisol",
      "test",
      "oxy"
    ];
    const modeTogglesEl = document.getElementById("modeToggles");
    const vectorSummaryEl = document.getElementById("vectorSummary");
    const nisBox = document.getElementById("nisBox");

    const audioMetaBand = document.getElementById("bandMeta");
    const audioMetaCarrier = document.getElementById("carrierMeta");
    const audioMetaPulse = document.getElementById("pulseMeta");
    const audioMetaBinaural = document.getElementById("binauralMeta");

    const compileBtn = document.getElementById("compileBtn");
    const randomizeBtn = document.getElementById("randomizeBtn");
    const playBtn = document.getElementById("playBtn");
    const stopBtn = document.getElementById("stopBtn");
    const volumeSlider = document.getElementById("volume");
    const unlockBanner = document.getElementById("unlockBanner");

    function getVector() {
      const v = {};
      sliders.forEach((id) => {
        const el = document.getElementById(id);
        v[id] = Number(el.value);
      });
      const modes = [];
      modeTogglesEl.querySelectorAll(".toggle").forEach((el) => {
        if (el.dataset.active === "true") modes.push(el.dataset.key);
      });
      return { ...v, modes };
    }

    function updateSliderLabels() {
      sliders.forEach((id) => {
        const el = document.getElementById(id);
        const label = document.getElementById(id + "Val");
        label.textContent = el.value;
      });
    }
    sliders.forEach((id) => {
      document.getElementById(id).addEventListener("input", () => {
        updateSliderLabels();
        describeVector();
        if (isPlaying && currentPatch) {
          applyLivePatchUpdate();
        }
      });
    });
    updateSliderLabels();

    modeTogglesEl.addEventListener("click", (e) => {
      const t = e.target;
      if (!t.classList.contains("toggle")) return;
      const active = t.dataset.active === "true";
      if (active && modeTogglesEl.querySelectorAll('.toggle[data-active="true"]').length === 1) {
        return;
      }
      t.dataset.active = active ? "false" : "true";
      describeVector();
      if (isPlaying && currentPatch) {
        applyLivePatchUpdate();
      }
    });

    function describeVector() {
      const v = getVector();
      const parts = [];

      function describe(name, val) {
        if (val === 0) return;
        const dir = val > 0 ? "+" : "–";
        parts.push(name + dir.repeat(Math.abs(val)));
      }
      describe("DA", v.dopamine);
      describe("5-HT", v.serotonin);
      describe("GABA", v.gaba);
      describe("ACh", v.ach);
      describe("CORT", v.cortisol);
      describe("T", v.test);
      describe("OXY", v.oxy);

      const modePart = v.modes.length ? v.modes.join(" / ") : "none";
      const txt =
        (parts.length ? parts.join(", ") : "neutral NT/hormone") +
        " • mode: " +
        modePart;
      vectorSummaryEl.textContent = txt;
    }
    describeVector();

    randomizeBtn.addEventListener("click", () => {
      sliders.forEach((id) => {
        const el = document.getElementById(id);
        const val = Math.floor(Math.random() * 11) - 5;
        el.value = val;
      });
      const toggles = Array.from(
        modeTogglesEl.querySelectorAll(".toggle")
      );
      toggles.forEach((t) => (t.dataset.active = "false"));
      const count = 1 + Math.floor(Math.random() * 2);
      for (let i = 0; i < count; i++) {
        const t = toggles[Math.floor(Math.random() * toggles.length)];
        t.dataset.active = "true";
      }
      updateSliderLabels();
      describeVector();
      if (isPlaying && currentPatch) applyLivePatchUpdate();
    });

    // ------- NIS COMPILER -------
    function compileNIS() {
      const v = getVector();
      const modes = v.modes;

      let band = "alpha";
      let hzRange = "8–12 Hz";
      if (modes.includes("focus") || modes.includes("drive")) {
        band = "high beta";
        hzRange = "18–24 Hz";
      } else if (modes.includes("calm") || modes.includes("grounded")) {
        band = "alpha / low beta";
        hzRange = "8–16 Hz";
      } else if (modes.includes("euphoria")) {
        band = "beta / gamma edges";
        hzRange = "18–32 Hz";
      } else if (modes.includes("social")) {
        band = "alpha / beta blend";
        hzRange = "10–18 Hz";
      }

      const da = v.dopamine;
      const cort = v.cortisol;
      const gaba = v.gaba;
      const ach = v.ach;
      const oxy = v.oxy;

      const block = [];
      block.push("NEURAL INSTRUCTION SEQUENCE / NIS");
      block.push("---------------------------------");
      block.push(`EEG-inspired band: ${band} (${hzRange})`);
      block.push(
        `Vector snapshot → DA ${da}, 5-HT ${v.serotonin}, GABA ${gaba}, ACh ${ach}, CORT ${cort}, T ${v.test}, OXY ${oxy}; modes: ${modes.join(
          " / "
        ) || "none"}`
      );
      block.push("");

      if (cort > 0 && gaba <= 0) {
        block.push(
          "Breath: extended exhale unloading (4-second inhale, 6–8-second exhale, 10-minute continuous)."
        );
      } else if (cort < 0 || gaba > 0 || modes.includes("calm")) {
        block.push(
          "Breath: low-noise nose breathing, 4-second inhale, 4-second exhale, no deliberate breath holds."
        );
      } else if (modes.includes("drive") || da > 1) {
        block.push(
          "Breath: performance block — one 'physiological sigh' every 2–3 minutes, otherwise natural nose breathing."
        );
      }

      if (modes.includes("focus") || ach > 0) {
        block.push(
          "Posture: seated, spine long but not rigid, feet flat, main task slightly below eye line."
        );
      }
      if (modes.includes("grounded") || gaba > 0 || oxy > 0) {
        block.push(
          "Grounding: keep both feet flat; every few minutes, touch a textured surface or thighs to re-anchor."
        );
      }

      if (modes.includes("calm") || cort > 1 || gaba > 0) {
        block.push(
          "Environment: low visual motion, fewer screens, dimmer lighting. One warm lamp over overhead glare."
        );
      } else if (modes.includes("drive") || modes.includes("focus")) {
        block.push(
          "Environment: single-focus. One active window or object; capture other ideas on paper instead of switching."
        );
      }

      if (modes.includes("focus")) {
        block.push(
          "Cognition: 50–90 minute deep-focus block. No tab-switch; track distractions but do not act on them."
        );
      }
      if (modes.includes("calm") || modes.includes("grounded")) {
        block.push(
          "Cognition: avoid deliberate replay. Label repetitive thoughts once ('planning', 'regret') and return to sensation."
        );
      }
      if (modes.includes("social") || oxy > 0) {
        block.push(
          "Cognition: rehearse one or two kind, concrete sentences you could say to someone you care about."
        );
      }

      let duration = 15;
      if (modes.includes("drive")) duration = 12;
      if (modes.includes("calm") || modes.includes("grounded")) duration = 20;
      block.push("");
      block.push(`Suggested session length: ${duration} minutes.`);
      block.push(
        "After the block: rate the shift from 0–10 in focus, calm, drive, and social ease (whichever modes you targeted)."
      );

      nisBox.textContent = block.join("\n");
      return { band, duration };
    }

    compileBtn.addEventListener("click", () => {
      currentPatch = buildPatchFromVector();
      const info = compileNIS();
      updateAudioMeta(currentPatch, info.band);
    });

    // ------- AUDIO ENGINE -------
    let audioCtx = null;
    let masterGain = null;
    let isPlaying = false;
    let currentOscLeft = null;
    let currentOscRight = null;
    let pulseGain = null;
    let pulseInterval = null;
    let currentPatch = null;

    function ensureAudioContext() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AC();
        masterGain = audioCtx.createGain();
        masterGain.gain.value = Number(volumeSlider.value);
        masterGain.connect(audioCtx.destination);
      }
      if (audioCtx.state === "suspended") {
        return audioCtx.resume();
      }
      return Promise.resolve();
    }

    function buildPatchFromVector() {
      const v = getVector();
      const modes = v.modes;

      let baseFreq = 220;
      if (modes.includes("focus") || v.ach > 0) baseFreq = 320;
      if (modes.includes("drive") || v.dopamine > 1) baseFreq = 360;
      if (modes.includes("calm") || v.gaba > 1 || v.cortisol < 0) baseFreq = 180;
      if (modes.includes("grounded")) baseFreq = 160;
      if (modes.includes("euphoria")) baseFreq = 400;

      let pulseHz = 10;
      let band = "alpha";
      if (modes.includes("focus") || modes.includes("drive")) {
        pulseHz = 18;
        band = "high beta";
      } else if (modes.includes("calm") || modes.includes("grounded")) {
        pulseHz = 8;
        band = "alpha";
      } else if (modes.includes("euphoria")) {
        pulseHz = 25;
        band = "beta / gamma";
      } else if (modes.includes("social")) {
        pulseHz = 12;
        band = "alpha / beta";
      }

      let binauralHz = 0;
      if (v.gaba > 0 || v.serotonin > 0 || modes.includes("calm")) {
        binauralHz = 4;
      } else if (modes.includes("focus") || modes.includes("drive")) {
        binauralHz = 12;
      }

      let warmth = 0.4;
      if (modes.includes("calm") || modes.includes("grounded") || v.oxy > 0) {
        warmth = 0.6;
      }
      if (modes.includes("euphoria")) warmth = 0.8;

      return {
        baseFreq,
        pulseHz,
        binauralHz,
        warmth,
        modes
      };
    }

    function updateAudioMeta(patch, bandLabel) {
      if (!patch) {
        audioMetaBand.textContent = "Band: –";
        audioMetaCarrier.textContent = "Carrier: – Hz";
        audioMetaPulse.textContent = "Pulse: – Hz";
        audioMetaBinaural.textContent = "Binaural: off";
        return;
      }
      audioMetaBand.textContent =
        "Band: " + (bandLabel || "EEG-ish " + patch.pulseHz + " Hz");
      audioMetaCarrier.textContent =
        "Carrier: " + patch.baseFreq.toFixed(0) + " Hz";
      audioMetaPulse.textContent = "Pulse: " + patch.pulseHz.toFixed(1) + " Hz";
      audioMetaBinaural.textContent =
        "Binaural: " + (patch.binauralHz ? patch.binauralHz + " Hz" : "off");
    }

    function startPatch() {
      if (!currentPatch) currentPatch = buildPatchFromVector();
      ensureAudioContext()
        .then(() => {
          unlockBanner.textContent =
            "Audio unlocked. You can adjust vector and pattern live while it plays.";

          stopPatch();
          const patch = currentPatch;

          const leftOsc = audioCtx.createOscillator();
          const rightOsc = audioCtx.createOscillator();
          const leftGain = audioCtx.createGain();
          const rightGain = audioCtx.createGain();
          pulseGain = audioCtx.createGain();

          const base = patch.baseFreq;
          const spread = base * patch.warmth * 0.2;
          leftOsc.frequency.value = base - spread;
          rightOsc.frequency.value = base + spread + patch.binauralHz;

          leftOsc.type = "sine";
          rightOsc.type = patch.warmth > 0.6 ? "triangle" : "sine";

          leftGain.gain.value = 0.55;
          rightGain.gain.value = 0.55;

          leftOsc.connect(leftGain);
          rightOsc.connect(rightGain);
          const merger = audioCtx.createChannelMerger(2);
          leftGain.connect(merger, 0, 0);
          rightGain.connect(merger, 0, 1);

          merger.connect(pulseGain);
          pulseGain.connect(masterGain);

          const pulseHz = patch.pulseHz;
          const pulsePeriod = 1 / pulseHz;
          const depth = 0.65;
          pulseGain.gain.value = 1 - depth / 2;

          const schedulePulse = () => {
            const now = audioCtx.currentTime;
            pulseGain.gain.cancelScheduledValues(now);
            for (let i = 0; i < 4; i++) {
              const t0 = now + i * pulsePeriod;
              const t1 = t0 + pulsePeriod / 2;
              pulseGain.gain.setValueAtTime(1, t0);
              pulseGain.gain.linearRampToValueAtTime(1 - depth, t1);
            }
          };
          schedulePulse();
          pulseInterval = setInterval(schedulePulse, 4000);

          leftOsc.start();
          rightOsc.start();

          currentOscLeft = leftOsc;
          currentOscRight = rightOsc;
          isPlaying = true;
          playBtn.textContent = "⏸ Pause patch";
          stopBtn.disabled = false;
          updateAudioMeta(patch);
          startPatternLoopIfNeeded();
        })
        .catch((err) => {
          console.error("Audio unlock error:", err);
          unlockBanner.textContent =
            "Audio blocked by browser. Try reloading and tapping Play again, with sound on.";
        });
    }

    function stopPatch() {
      if (pulseInterval) {
        clearInterval(pulseInterval);
        pulseInterval = null;
      }
      if (currentOscLeft) {
        try { currentOscLeft.stop(); } catch (e) {}
        currentOscLeft.disconnect();
        currentOscLeft = null;
      }
      if (currentOscRight) {
        try { currentOscRight.stop(); } catch (e) {}
        currentOscRight.disconnect();
        currentOscRight = null;
      }
      stopPatternLoop();
      isPlaying = false;
      playBtn.textContent = "▶ Play patch";
      stopBtn.disabled = true;
    }

    function applyLivePatchUpdate() {
      if (!audioCtx || !isPlaying || !currentOscLeft || !currentOscRight)
        return;
      const patch = (currentPatch = buildPatchFromVector());
      const base = patch.baseFreq;
      const spread = base * patch.warmth * 0.2;
      currentOscLeft.frequency.setTargetAtTime(
        base - spread,
        audioCtx.currentTime,
        0.1
      );
      currentOscRight.frequency.setTargetAtTime(
        base + spread + patch.binauralHz,
        audioCtx.currentTime,
        0.1
      );
      updateAudioMeta(patch);
    }

    playBtn.addEventListener("click", () => {
      if (!isPlaying) {
        startPatch();
      } else {
        stopPatch();
      }
    });

    stopBtn.addEventListener("click", () => {
      stopPatch();
    });

    volumeSlider.addEventListener("input", () => {
      if (masterGain) {
        masterGain.gain.value = Number(volumeSlider.value);
      }
    });

    currentPatch = buildPatchFromVector();
    updateAudioMeta(currentPatch, null);

    // ------- PATTERN LAYER -------
    const patternGrid = document.getElementById("patternGrid");
    const patternSubtitle = document.getElementById("patternSubtitle");
    const patternToggleBtn = document.getElementById("patternToggleBtn");
    const patternTempoSlider = document.getElementById("patternTempo");
    const patternTempoVal = document.getElementById("patternTempoVal");
    const patternDepthSlider = document.getElementById("patternDepth");
    const patternDepthVal = document.getElementById("patternDepthVal");
    const patternRandomBtn = document.getElementById("patternRandomBtn");
    const patternClearBtn = document.getElementById("patternClearBtn");

    const PATTERN_STEPS = 8;
    let pattern = Array(PATTERN_STEPS).fill(0); // 0=off,1=low,2=high
    let patternEnabled = false;
    let patternTimer = null;
    let patternStep = 0;

    function buildPatternGrid() {
      patternGrid.innerHTML = "";
      for (let i = 0; i < PATTERN_STEPS; i++) {
        const cell = document.createElement("div");
        cell.className = "pattern-cell";
        cell.dataset.step = String(i);
        cell.dataset.level = String(pattern[i]);
        cell.addEventListener("click", () => {
          let level = pattern[i];
          level = (level + 1) % 3;
          pattern[i] = level;
          cell.dataset.level = String(level);
          updatePatternSubtitleIdle();
        });
        patternGrid.appendChild(cell);
      }
    }
    buildPatternGrid();

    function updatePatternTempoLabel() {
      patternTempoVal.textContent = patternTempoSlider.value;
    }
    function updatePatternDepthLabel() {
      patternDepthVal.textContent = Number(patternDepthSlider.value).toFixed(2);
    }
    updatePatternTempoLabel();
    updatePatternDepthLabel();

    patternTempoSlider.addEventListener("input", () => {
      updatePatternTempoLabel();
      if (patternTimer) {
        startPatternLoopIfNeeded(); // restart with new tempo
      }
    });
    patternDepthSlider.addEventListener("input", () => {
      updatePatternDepthLabel();
    });

    function setPatternActiveStepHighlight(stepIndex) {
      const cells = patternGrid.querySelectorAll(".pattern-cell");
      cells.forEach((cell) => {
        if (Number(cell.dataset.step) === stepIndex) {
          cell.dataset.activeStep = "true";
        } else {
          cell.dataset.activeStep = "false";
        }
      });
    }

    function updatePatternSubtitleIdle() {
      const active = pattern.reduce((a, v) => a + v, 0);
      if (!patternEnabled) {
        patternSubtitle.textContent =
          active === 0
            ? "Pattern idle. Draw a shape, then enable it while audio is playing."
            : "Pattern drawn but disabled. Toggle it on to hear motion.";
      } else {
        if (active === 0) {
          patternSubtitle.textContent =
            "Pattern enabled but empty. Light some steps to hear movement.";
        }
      }
    }
    updatePatternSubtitleIdle();

    function patternStepDescription(step, level) {
      if (level === 0) return `Step ${step + 1}: neutral / bridge.`;
      if (level === 1)
        return `Step ${step + 1}: gentle push in your current mode (small tilt of freq + pulse).`;
      return `Step ${step + 1}: strong push — deeper into your current mode for this moment.`;
    }

    function applyPatternModulation(stepIndex) {
      if (!audioCtx || !isPlaying || !currentOscLeft || !currentOscRight) return;
      const level = pattern[stepIndex];
      const depth = Number(patternDepthSlider.value);
      const patch = currentPatch || buildPatchFromVector();
      const base = patch.baseFreq;
      const spread = base * patch.warmth * 0.2;

      const factor = 1 + (level * 0.06 * depth); // small expansion

      const leftTarget = (base - spread) * factor;
      const rightTarget = (base + spread + patch.binauralHz) * factor;

      currentOscLeft.frequency.setTargetAtTime(
        leftTarget,
        audioCtx.currentTime,
        0.08
      );
      currentOscRight.frequency.setTargetAtTime(
        rightTarget,
        audioCtx.currentTime,
        0.08
      );

      setPatternActiveStepHighlight(stepIndex);
      patternSubtitle.textContent = patternStepDescription(stepIndex, level);
    }

    function startPatternLoopIfNeeded() {
      stopPatternLoop();
      if (!patternEnabled || !isPlaying) {
        setPatternActiveStepHighlight(-1);
        updatePatternSubtitleIdle();
        return;
      }
      const bpm = Number(patternTempoSlider.value);
      const stepDuration = 60 / bpm; // one beat per step

      patternStep = 0;
      applyPatternModulation(patternStep);

      patternTimer = setInterval(() => {
        if (!isPlaying || !patternEnabled) {
          stopPatternLoop();
          return;
        }
        patternStep = (patternStep + 1) % PATTERN_STEPS;
        applyPatternModulation(patternStep);
      }, stepDuration * 1000);
    }

    function stopPatternLoop() {
      if (patternTimer) {
        clearInterval(patternTimer);
        patternTimer = null;
      }
      setPatternActiveStepHighlight(-1);
    }

    patternToggleBtn.addEventListener("click", () => {
      patternEnabled = !patternEnabled;
      patternToggleBtn.dataset.enabled = patternEnabled ? "true" : "false";
      patternToggleBtn.textContent = patternEnabled
        ? "✱ Pattern ON"
        : "✱ Enable pattern";
      if (patternEnabled && isPlaying) {
        startPatternLoopIfNeeded();
      } else {
        stopPatternLoop();
      }
      updatePatternSubtitleIdle();
    });

    patternRandomBtn.addEventListener("click", () => {
      pattern = pattern.map(() => {
        const r = Math.random();
        if (r < 0.5) return 0;
        if (r < 0.8) return 1;
        return 2;
      });
      buildPatternGrid();
      updatePatternSubtitleIdle();
    });

    patternClearBtn.addEventListener("click", () => {
      pattern = Array(PATTERN_STEPS).fill(0);
      buildPatternGrid();
      updatePatternSubtitleIdle();
    });
  </script>
</body>
</html>
